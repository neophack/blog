---
title: Ubuntu18.04LTS+cuda9.0+caffe(old repo老版本)安装踩坑
date: 2018-10-30 20:15:51
tags: caffe配置
categories: 深度学习
---
在Ubuntu上安装cuda9.0，并配置caffe环境，caffe为2016年的版本，由于改动太多，移植到新版麻烦，这里就安装教程和遇到问题做一些记录

<!-- more -->


### 1.常用编译需要的软件
首先安装必要软件
```bash
sudo apt install make cmake
```

编译GPU版需要安装驱动
```bash
chmod 777 NVIDIA-Linux-x86_64-410.73.run
sudo ./NVIDIA-Linux-x86_64-410.73.run --no-opengl-files
# --no-opengl-files适合笔记本用户安装，可以防止桌面分辨率异常，台式机可以不加
chmod 777 cuda_9.0.176_384.81_linux.run
sudo ./cuda_9.0.176_384.81_linux.run
# cuda安装时候提示安装驱动，选n
```

### 2.安装caffe需要的库
```bash
sudo apt install libprotobuf-dev libleveldb-dev libsnappy-dev libopencv-dev libhdf5-serial-dev protobuf-compiler
sudo apt install --no-install-recommends libboost-all-dev
sudo apt install libatlas-base-dev
sudo apt install libgflags-dev libgoogle-glog-dev liblmdb-dev
```
### 3.根据自己配置修改Makefile.config，主要是是否使用cudnn、仅使用CPU、cuda9注意删除CUDA_ARCH 中的20和21两行

### 4.编译

```bash
make all
```

# 注意

### 1 如果报错如下，protobuf版本不一致

    .build_release/src/caffe/proto/caffe.pb.h:17:2: error: #error This file was generated by an older version of protoc which is

默认protobuf为3.0版本，旧版2.5版本安装如下 
```bash
wget http://archive.ubuntu.com/ubuntu/pool/main/p/protobuf/libprotobuf8_2.5.0-9ubuntu1_amd64.deb
wget http://archive.ubuntu.com/ubuntu/pool/main/p/protobuf/libprotobuf-lite8_2.5.0-9ubuntu1_amd64.deb
wget http://archive.ubuntu.com/ubuntu/pool/main/p/protobuf/libprotobuf-dev_2.5.0-9ubuntu1_amd64.deb
sudo dpkg -i libprotobuf8_2.5.0-9ubuntu1_amd64.deb libprotobuf-lite8_2.5.0-9ubuntu1_amd64.deb libprotobuf-dev_2.5.0-9ubuntu1_amd64.deb
```

更多库下载

https://ubuntu.pkgs.org/14.04/ubuntu-main-amd64/libprotobuf-lite8_2.5.0-9ubuntu1_amd64.deb.html


### 2 如果报错如下，为g++版本不兼容

    src/caffe/layers/contrastive_loss_layer.cpp:56:30: error: no matching function for call to ‘max(float, double)’

     Dtype dist = std::max(margin - sqrt(dist_sq_.cpu_data()[i]), 0.0);

通过安装低版本gcc g++解决
```bash
sudo apt install gcc-4.8 g++-4.8
cd /usr/bin
sudo ln -s gcc-4.8 gcc
sudo ln -s g++-4.8 g++
```

### 3 如果报错如下，anaconda库冲突

    CXX/LD -o .build_release/tools/upgrade_net_proto_text.bin
    .build_release/tools/upgrade_net_proto_text.o: In function `main':
    /usr/include/c++/5/bits/basic_string.tcc:219: undefined reference to `std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >::_M_create(unsigned long&, unsigned long)'
    /usr/lib/gcc/x86_64-linux-gnu/5/../../../x86_64-linux-gnu/libglog.so: undefined reference to `vtable for std::__cxx11::basic_stringbuf<char, std::char_traits<char>, std::allocator<char> >@GLIBCXX_3.4.21'

 在makefile.config修改include路径lib路径等，编译pycaffe时再添加Python的include路径lib路径
```bash
# Whatever else you find you need goes here.
#INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include $(CUDNN_PATH)
#LIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib $(CUDNN_PATH)
INCLUDE_DIRS := /usr/local/include /usr/include/hdf5/serial /usr/include/python2.7 $(CUDNN_PATH)
LIBRARY_DIRS := /usr/local/lib /usr/lib /usr/lib/x86_64-linux-gnu/hdf5/serial $(CUDNN_PATH)
```

### 4 cublas报错

    F1030 16:15:43.990840  1937 math_functions.cu:28] Check failed: status == CUBLAS_STATUS_SUCCESS (13 vs. 0)  CUBLAS_STATUS_EXECUTION_FAILED

安装CUDA9.0会出现以上错误

通过安装补丁[Patch 2 (Released Mar 5, 2018)](https://developer.nvidia.com/cuda-90-download-archive?target_os=Linux&target_arch=x86_64&target_distro=Ubuntu&target_version=1704&target_type=runfilelocal)解决

# 训练模型
![caffe-train](/imgs/2018-10-30-caffe-train.jpg)
![GPU](/imgs/2018-10-30-nvidia-smi.jpg)
 

声明：如有错误或者侵权请邮箱联系我